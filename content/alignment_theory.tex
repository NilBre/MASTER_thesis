\chapter{The Theory of Alignment}
\label{sec:alignTheory}

here comes the theory part for general alignment

\section{Track reconstruction}
\label{sec:kalman}
%talk pdf. quelle herausfinden!

In order to function optimally, the LHCb detector stands before a difficult duty.
The track reconstruction algorithm needs to find the correct hits from each subdetector to build the track. This can be problematic just because of the amount of tracks per events (roughly 100).
It is crucial to find all particle tracks and also their track parameters which come from the track fit.


A good track fit is needed in order to find to best estimates for the track parameters and covariances. The estimates are used in the event reconstruction to find the correct tracks for each particle and the decay products. The info provided is used in the RICH rings, ECAL and HCAL and muon detectors. With these information, particle and track parameters such as the invariant mass can be measured and vertex origins can be found.
There are several track models that can be used. In general, a track is build from numnerous segments which are either straight or curved because of an active magnetic field. Depending on the environment of the track either model is good.
The track segments are called track states and are defined by a position in $x$ and $y$ at a given distance $z$ where the hit was located, then a tanget direction $t_{x,y}$ at the hit position and a momentum parameter acquired from the track curve inside the magnetic field.\cite{VanTilburg}

\begin{align}
  \vec{r} = \left(\begin{array}{c} x \\ y \\ t_x \\ t_y \\ \frac{q}{p}\end{array}\right) & t_x = \frac{\partial x}{\partial z} & t_y = \frac{\partial y}{\partial z}
\end{align}

The uncertainty of the five-component state vector is a $5\times5$ covariance matrix $C$.
A track state can be anywhere on the trajectory but is easier to choose it at real detection points. Combining the track state with a real measurement point is called \textit{node}.
The propagation from node $k_{-1}$ to node $k$ is described by a propagation function

\begin{equation}
  \vec{r}_k = f_k(\vec{r}_{k_{-1}}) + \vec{w}_k
\end{equation}\,.

This means node $k$ is acquired by propagating node $k-1$ through the propagation function $f_k$ and shifting it by the \textit{process noise} $\vec{w}_k$.
Process noise can be caused by any scattering phenomenon that may have happened.

Depending on the type of propagation, linear or curved, a different propagation function is used.
for a linear extrapolation, $f_k$ results in
\begin{equation}
  f_k \left(\vec{r}_{k-1}\right) = F_k \vec{r}_{k-1}
\end{equation}
with the transport matrix $F_k$
\begin{gather}
  F_K = \begin{pmatrix}
    1 & 0 & \Delta z & 0 & 0 \\
    0 & 1 & 0 & \Delta z & 0 \\
    0 & 0 & 1 & 0 & 0 \\
    0 & 0 & 0 & 1 & 0 \\
    0 & 0 & 0 & 0 & 1 \\
  \end{pmatrix}
\end{gather}
and $\Delta z$ being the difference in z between the nodes
\begin{equation}
  \Delta z = z_k - z_{k-1}
\end{equation}


Trajectory information for each node is provided by the real measurement where the relation between measurement $m_k$ and track state at a given node $k$ is defined as

\begin{equation}
  m_k = h_k(\vec{r}_k) + \epsilon_k
\end{equation}

with the projection function $h_k$ and \textit{measurement noise} $\epsilon_k$.
So if the detector only measures the $y$ coordinate of state, the projection function
will be
\begin{equation}
  h_k(\vec{r}_k) = H_k \vec{r}_k
\end{equation}
with
\begin{gather}
  H_k = \begin{pmatrix}
    0 & 1 & 0 & 0 & 0 \\
  \end{pmatrix}
\end{gather}\,.

When measuring more parameters the measurement matrix $H_k$ and projection matrix have dimension $n\times5$ with $n$ being the numbers of parameters measured.

With this track model, both noises from the measurement and the process are random and unknown and have an expectation value of zero.
They are defined as $W_k \equiv cov(w_k)$ and $V_k \equiv cov(\epsilon_k)$.

% now kalman filter formalism
\section{The Kalman filter method \cite{VanTilburg}}
In general a track is an ensemble of measurements and track states and the Kalman filter method is used to fit tracks.
The idea of the Kalman filter is, to have a starting node and add measurements one by one. In between the addition of measurements, the local track state is updated with the new information.
The Kalman filter method is a $\chi^2$ minimising problem for the measurement of the track. Because of the iterative nature of the method, it is fast und also used in other fields than physics, for example GPS and meteorology.
The three steps of the Kalman filter will be briefly outlined and later discribed in further detail.


The first step is the $\symbf{\symup{Prediction}}$: The next track state of the trajectory is predicted based on the track state at the previous node.
The second step is the $\symbf{\symup{Filter}}$ procedure: By using filter equations, the prediction is updated with measurement information in this node. The prediction and filter are repeated for each measurement. With more measurements added, the estimate for the best trajectory is the track state after each filter step.
The final step is called $\symbf{\symup{Smoother}}$: When the trajectory is complete, smoother equations are applied from the last node to the previous node. Therefore the information from all measurements is used in both forward- and backpropagation which results in a "smoother" track.

\subsection{1. Step: Prediction}
For a given state vector at node \textit{p-1}, the prediction for the $p^{\text{th}}$ state vector and its covariance matrix results from the propagation relations

\begin{align}
  \vec{r}_p^{p-1} &= f_p\left( \vec{r}_{p-1} \right) \\
  \text{Cov}_p^{p-1} &= F_p C_{p-1} F_p^T + Q_k
\end{align}

The superscript of the statevector shows the number of measurements used in the estimate and can be abbreviated with $\vec{r}_p^p \equiv \vec{r}_p$. For a maximum number of n measurements $\vec{r}_p^n$ is the smoothed state where every measurement is used.
$Q_p$ is the process noise in matrix form and it is part of the predicted covariance matrix $C_p^{p-1}$.
Because the first state cannot take measurements from the previous state, an initial prediction is taken from the track finding algorithm instead.
The predicted residual between the measurement, $m_p$ and the state vector results in
\begin{equation}
  \text{res}_p^{p-1} = m_p - h_p\left( \vec{r}_p^{p-1} \right)
\end{equation}
and the corresponding covariance matrix is defined as
\begin{equation}
  \text{Cov}_{\text{res},p}^{p-1} = V_p + H_p C_p^{p-1} H_P^T
\end{equation}\,.

Here, $V_p$ is the measurement variance. With these metrics the minimal $\chi^2$ for the optimal track states can be calculated via
\begin{equation}
  \left( \chi^2 \right)_p^{p-1} = \text{res}_p^{p-1} \left(\text{Cov}_{\text{res},p}^{p-1}\right)^{-1} \text{res}_p^{p-1}
\end{equation}

\subsection{2. Step: Filter}
During the filter step, the track state is updated with the measurement information.
Iteratively, each measurement is added and the filtered state $\vec{r}_p$ and the corresponding covariance matrix is calculated via
\begin{align}
  \vec{r}_p &= \vec{r}_p^{p-1} + G_p \text{res}+p^{p-1} \\
  \text{Cov}_p &= \left(\mathbb{1} - G_p H_p\right) \text{Cov}_p^{p-1}
\end{align}\,,
where $G_p$ is the gain matrix of dimension $5\times1$ and is defined as
\begin{equation}
  G_p = C_p^{p-1} H_p^T \left( \text{Cov}_{\text{res},p}^{p-1} \right)^{-1}
\end{equation}

Afterwards the residuals and its covariance matrix are calculated and the filtered total $\chi^2$ is defined as
\begin{equation}
  \left( \chi^2_{\text{filter}} \right)_p = \text{res}_p \text{Cov}_{\text{res},p}^{-1} \text{res}_p
\end{equation}\,.

The prediction and filter procedure is continued for all measurements until the track is fully reconstructed.
Because the last node at $p \, = \, n$ has the most information in it, a backward update is performed to infuse the previous nodes with the same information as in last node.
This is called \textit{smoother}-step.

\subsection{3. Step: Smoother}
The smoother function returns the best possible estimate for track states at
the previous nodes. The method used is called \textit{Rauch-Tung-Striebel}-smoother.
The idea is to used backward information and construct a smoothed state vector and covariance matrix
\begin{align}
  \tilde{r}_p^n &= \vec{r}_p + S_p \left( \vec{r}_{p+1}^n - \vec{r}_{p+1}^p \right) \\
  \tilde{C}_p^n &= C_p
\end{align}
and the Smoother-matrix $S_p$ of dimension $5\times5$
\begin{equation}
  S_p = C_p F_{p+1}^T \left( C_{p+1}^p \right)^{-1}
\end{equation}\,.

In order to calculate the smoothed $\chi^2$ the residual and correspending covariance matrix are
\begin{align}
  \text{res}_p &= m_p - h_p \vec{h}_p^n \\
  \text{Cov}_{\text{res},p}^n &= V_p - H_p C_p^n H_p^T
\end{align}
An in depth explanation is given in \cite{RTS}.

The $\chi^2$ is calculated analogously to the one during the filter step with the difference being the new residuals and covariances.

\section{Alignment using derivatives}
\label{sec:derivatives}
% wouter



%%%%%%% notes %%%%%%%
%wouter pdf. quelle herausfinden!

%martinelli pdf! use some of that information
% -> alignment is a minimizing problem (chi2) thats why i looked at chi2 plots
%
% -> global translation and sheering motion don't change chi2 values because residuals are unchanged.
%
% -> weak modes: presence of weak modes affect the convergence (poor, takes many iterations), bias in track parameters.
%
% -> most visible weak modes is the "curvature bias" (sophie has mentioned it sometime. must be on one of my sheets)
% also look at twiki!
%
% goals:
% source for now: DPG2021 pdf exact source will be included!

% \begin{enumerate}
%   \item find the best possible configuration of alignables, degrees of freedom, constraints
%   \item check for weak modes (how? chi2, small eigenvalues)
%   \item null tests as good as possible
%   \item misalignment tests to check alignment
% \end{enumerate}
